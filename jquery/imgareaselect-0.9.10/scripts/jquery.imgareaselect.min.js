(function($){'use strict';var p=Math.abs,max=Math.max,min=Math.min,round=Math.round;function div(){return $('<div/>')}$.imgAreaSelect=function(g,j){var l=$(g),imgLoaded,$box=div(),$area=div(),$border=div().add(div()).add(div()).add(div()),$outer=div().add(div()).add(div()).add(div()),$handles=$([]),$areaOpera,left,top,imgOfs={left:0,top:0},imgWidth,imgHeight,$parent,parOfs={left:0,top:0},zIndex=0,position='absolute',startX,startY,scaleX,scaleY,resize,minWidth,minHeight,maxWidth,maxHeight,aspectRatio,shown,x1,y1,x2,y2,selection={x1:0,y1:0,x2:0,y2:0,width:0,height:0},docElem=document.documentElement,ua=navigator.userAgent,$p,d,i,o,w,h,adjusted;function viewX(x){return x+imgOfs.left-parOfs.left}function viewY(y){return y+imgOfs.top-parOfs.top}function selX(x){return x-imgOfs.left+parOfs.left}function selY(y){return y-imgOfs.top+parOfs.top}function evX(a){return a.pageX-parOfs.left}function evY(a){return a.pageY-parOfs.top}function getSelection(a){var b=a||scaleX,sy=a||scaleY;return{x1:round(selection.x1*b),y1:round(selection.y1*sy),x2:round(selection.x2*b),y2:round(selection.y2*sy),width:round(selection.x2*b)-round(selection.x1*b),height:round(selection.y2*sy)-round(selection.y1*sy)}}function setSelection(a,b,c,d,e){var f=e||scaleX,sy=e||scaleY;selection={x1:round(a/f||0),y1:round(b/sy||0),x2:round(c/f||0),y2:round(d/sy||0)};selection.width=selection.x2-selection.x1;selection.height=selection.y2-selection.y1}function adjust(){if(!imgLoaded||!l.width())return;imgOfs={left:round(l.offset().left),top:round(l.offset().top)};imgWidth=l.innerWidth();imgHeight=l.innerHeight();imgOfs.top+=(l.outerHeight()-imgHeight)>>1;imgOfs.left+=(l.outerWidth()-imgWidth)>>1;minWidth=round(j.minWidth/scaleX)||0;minHeight=round(j.minHeight/scaleY)||0;maxWidth=round(min(j.maxWidth/scaleX||1<<24,imgWidth));maxHeight=round(min(j.maxHeight/scaleY||1<<24,imgHeight));if($().jquery=='1.3.2'&&position=='fixed'&&!docElem['getBoundingClientRect']){imgOfs.top+=max(document.body.scrollTop,docElem.scrollTop);imgOfs.left+=max(document.body.scrollLeft,docElem.scrollLeft)}parOfs=/absolute|relative/.test($parent.css('position'))?{left:round($parent.offset().left)-$parent.scrollLeft(),top:round($parent.offset().top)-$parent.scrollTop()}:position=='fixed'?{left:$(document).scrollLeft(),top:$(document).scrollTop()}:{left:0,top:0};left=viewX(0);top=viewY(0);if(selection.x2>imgWidth||selection.y2>imgHeight)doResize()}function update(a){if(!shown)return;$box.css({left:viewX(selection.x1),top:viewY(selection.y1)}).add($area).width(w=selection.width).height(h=selection.height);$area.add($border).add($handles).css({left:0,top:0});$border.width(max(w-$border.outerWidth()+$border.innerWidth(),0)).height(max(h-$border.outerHeight()+$border.innerHeight(),0));$($outer[0]).css({left:left,top:top,width:selection.x1,height:imgHeight});$($outer[1]).css({left:left+selection.x1,top:top,width:w,height:selection.y1});$($outer[2]).css({left:left+selection.x2,top:top,width:imgWidth-selection.x2,height:imgHeight});$($outer[3]).css({left:left+selection.x1,top:top+selection.y2,width:w,height:imgHeight-selection.y2});w-=$handles.outerWidth();h-=$handles.outerHeight();switch($handles.length){case 8:$($handles[4]).css({left:w>>1});$($handles[5]).css({left:w,top:h>>1});$($handles[6]).css({left:w>>1,top:h});$($handles[7]).css({top:h>>1});case 4:$handles.slice(1,3).css({left:w});$handles.slice(2,4).css({top:h})}if(a!==false){if($.imgAreaSelect.onKeyPress!=m)$(document).unbind($.imgAreaSelect.keyPress,$.imgAreaSelect.onKeyPress);if(j.keys)$(document)[$.imgAreaSelect.keyPress]($.imgAreaSelect.onKeyPress=m)}if(n&&$border.outerWidth()-$border.innerWidth()==2){$border.css('margin',0);setTimeout(function(){$border.css('margin','auto')},0)}}function doUpdate(a){adjust();update(a);x1=viewX(selection.x1);y1=viewY(selection.y1);x2=viewX(selection.x2);y2=viewY(selection.y2)}function hide(a,b){j.fadeSpeed?a.fadeOut(j.fadeSpeed,b):a.hide()}function areaMouseMove(a){var x=selX(evX(a))-selection.x1,y=selY(evY(a))-selection.y1;if(!adjusted){adjust();adjusted=true;$box.one('mouseout',function(){adjusted=false})}resize='';if(j.resizable){if(y<=j.resizeMargin)resize='n';else if(y>=selection.height-j.resizeMargin)resize='s';if(x<=j.resizeMargin)resize+='w';else if(x>=selection.width-j.resizeMargin)resize+='e'}$box.css('cursor',resize?resize+'-resize':j.movable?'move':'');if($areaOpera)$areaOpera.toggle()}function docMouseUp(a){$('body').css('cursor','');if(j.autoHide||selection.width*selection.height==0)hide($box.add($outer),function(){$(this).hide()});$(document).unbind('mousemove',selectingMouseMove);$box.mousemove(areaMouseMove);j.onSelectEnd(g,getSelection())}function areaMouseDown(a){if(a.which!=1)return false;adjust();if(resize){$('body').css('cursor',resize+'-resize');x1=viewX(selection[/w/.test(resize)?'x2':'x1']);y1=viewY(selection[/n/.test(resize)?'y2':'y1']);$(document).mousemove(selectingMouseMove).one('mouseup',docMouseUp);$box.unbind('mousemove',areaMouseMove)}else if(j.movable){startX=left+selection.x1-evX(a);startY=top+selection.y1-evY(a);$box.unbind('mousemove',areaMouseMove);$(document).mousemove(movingMouseMove).one('mouseup',function(){j.onSelectEnd(g,getSelection());$(document).unbind('mousemove',movingMouseMove);$box.mousemove(areaMouseMove)})}else l.mousedown(a);return false}function fixAspectRatio(a){if(aspectRatio)if(a){x2=max(left,min(left+imgWidth,x1+p(y2-y1)*aspectRatio*(x2>x1||-1)));y2=round(max(top,min(top+imgHeight,y1+p(x2-x1)/aspectRatio*(y2>y1||-1))));x2=round(x2)}else{y2=max(top,min(top+imgHeight,y1+p(x2-x1)/aspectRatio*(y2>y1||-1)));x2=round(max(left,min(left+imgWidth,x1+p(y2-y1)*aspectRatio*(x2>x1||-1))));y2=round(y2)}}function doResize(){x1=min(x1,left+imgWidth);y1=min(y1,top+imgHeight);if(p(x2-x1)<minWidth){x2=x1-minWidth*(x2<x1||-1);if(x2<left)x1=left+minWidth;else if(x2>left+imgWidth)x1=left+imgWidth-minWidth}if(p(y2-y1)<minHeight){y2=y1-minHeight*(y2<y1||-1);if(y2<top)y1=top+minHeight;else if(y2>top+imgHeight)y1=top+imgHeight-minHeight}x2=max(left,min(x2,left+imgWidth));y2=max(top,min(y2,top+imgHeight));fixAspectRatio(p(x2-x1)<p(y2-y1)*aspectRatio);if(p(x2-x1)>maxWidth){x2=x1-maxWidth*(x2<x1||-1);fixAspectRatio()}if(p(y2-y1)>maxHeight){y2=y1-maxHeight*(y2<y1||-1);fixAspectRatio(true)}selection={x1:selX(min(x1,x2)),x2:selX(max(x1,x2)),y1:selY(min(y1,y2)),y2:selY(max(y1,y2)),width:p(x2-x1),height:p(y2-y1)};update();j.onSelectChange(g,getSelection())}function selectingMouseMove(a){x2=/w|e|^$/.test(resize)||aspectRatio?evX(a):viewX(selection.x2);y2=/n|s|^$/.test(resize)||aspectRatio?evY(a):viewY(selection.y2);doResize();return false}function doMove(a,b){x2=(x1=a)+selection.width;y2=(y1=b)+selection.height;$.extend(selection,{x1:selX(x1),y1:selY(y1),x2:selX(x2),y2:selY(y2)});update();j.onSelectChange(g,getSelection())}function movingMouseMove(a){x1=max(left,min(startX+evX(a),left+imgWidth-selection.width));y1=max(top,min(startY+evY(a),top+imgHeight-selection.height));doMove(x1,y1);a.preventDefault();return false}function startSelection(){$(document).unbind('mousemove',startSelection);adjust();x2=x1;y2=y1;doResize();resize='';if(!$outer.is(':visible'))$box.add($outer).hide().fadeIn(j.fadeSpeed||0);shown=true;$(document).unbind('mouseup',cancelSelection).mousemove(selectingMouseMove).one('mouseup',docMouseUp);$box.unbind('mousemove',areaMouseMove);j.onSelectStart(g,getSelection())}function cancelSelection(){$(document).unbind('mousemove',startSelection).unbind('mouseup',cancelSelection);hide($box.add($outer));setSelection(selX(x1),selY(y1),selX(x1),selY(y1));if(!(this instanceof $.imgAreaSelect)){j.onSelectChange(g,getSelection());j.onSelectEnd(g,getSelection())}}function imgMouseDown(a){if(a.which!=1||$outer.is(':animated'))return false;adjust();startX=x1=evX(a);startY=y1=evY(a);$(document).mousemove(startSelection).mouseup(cancelSelection);return false}function windowResize(){doUpdate(false)}function imgLoad(){imgLoaded=true;setOptions(j=$.extend({classPrefix:'imgareaselect',movable:true,parent:'body',resizable:true,resizeMargin:10,onInit:function(){},onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}},j));$box.add($outer).css({visibility:''});if(j.show){shown=true;adjust();update();$box.add($outer).hide().fadeIn(j.fadeSpeed||0)}setTimeout(function(){j.onInit(g,getSelection())},0)}var m=function(a){var k=j.keys,d,t,key=a.keyCode;d=!isNaN(k.alt)&&(a.altKey||a.originalEvent.altKey)?k.alt:!isNaN(k.ctrl)&&a.ctrlKey?k.ctrl:!isNaN(k.shift)&&a.shiftKey?k.shift:!isNaN(k.arrows)?k.arrows:10;if(k.arrows=='resize'||(k.shift=='resize'&&a.shiftKey)||(k.ctrl=='resize'&&a.ctrlKey)||(k.alt=='resize'&&(a.altKey||a.originalEvent.altKey))){switch(key){case 37:d=-d;case 39:t=max(x1,x2);x1=min(x1,x2);x2=max(t+d,x1);fixAspectRatio();break;case 38:d=-d;case 40:t=max(y1,y2);y1=min(y1,y2);y2=max(t+d,y1);fixAspectRatio(true);break;default:return}doResize()}else{x1=min(x1,x2);y1=min(y1,y2);switch(key){case 37:doMove(max(x1-d,left),y1);break;case 38:doMove(x1,max(y1-d,top));break;case 39:doMove(x1+min(d,imgWidth-selX(x2)),y1);break;case 40:doMove(x1,y1+min(d,imgHeight-selY(y2)));break;default:return}}return false};function styleOptions(a,b){for(var c in b)if(j[c]!==undefined)a.css(b[c],j[c])}function setOptions(a){if(a.parent)($parent=$(a.parent)).append($box.add($outer));$.extend(j,a);adjust();if(a.handles!=null){$handles.remove();$handles=$([]);i=a.handles?a.handles=='corners'?4:8:0;while(i--)$handles=$handles.add(div());$handles.addClass(j.classPrefix+'-handle').css({position:'absolute',fontSize:0,zIndex:zIndex+1||1});if(!parseInt($handles.css('width'))>=0)$handles.width(5).height(5);if(o=j.borderWidth)$handles.css({borderWidth:o,borderStyle:'solid'});styleOptions($handles,{borderColor1:'border-color',borderColor2:'background-color',borderOpacity:'opacity'})}scaleX=j.imageWidth/imgWidth||1;scaleY=j.imageHeight/imgHeight||1;if(a.x1!=null){setSelection(a.x1,a.y1,a.x2,a.y2);a.show=!a.hide}if(a.keys)j.keys=$.extend({shift:1,ctrl:'resize'},a.keys);$outer.addClass(j.classPrefix+'-outer');$area.addClass(j.classPrefix+'-selection');for(i=0;i++<4;)$($border[i-1]).addClass(j.classPrefix+'-border'+i);styleOptions($area,{selectionColor:'background-color',selectionOpacity:'opacity'});styleOptions($border,{borderOpacity:'opacity',borderWidth:'border-width'});styleOptions($outer,{outerColor:'background-color',outerOpacity:'opacity'});if(o=j.borderColor1)$($border[0]).css({borderStyle:'solid',borderColor:o});if(o=j.borderColor2)$($border[1]).css({borderStyle:'dashed',borderColor:o});$box.append($area.add($border).add($areaOpera)).append($handles);if(n){if(o=($outer.css('filter')||'').match(/opacity=(\d+)/))$outer.css('opacity',o[1]/100);if(o=($border.css('filter')||'').match(/opacity=(\d+)/))$border.css('opacity',o[1]/100)}if(a.hide)hide($box.add($outer));else if(a.show&&imgLoaded){shown=true;$box.add($outer).fadeIn(j.fadeSpeed||0);doUpdate()}aspectRatio=(d=(j.aspectRatio||'').split(/:/))[0]/d[1];l.add($outer).unbind('mousedown',imgMouseDown);if(j.disable||j.enable===false){$box.unbind('mousemove',areaMouseMove).unbind('mousedown',areaMouseDown);$(window).unbind('resize',windowResize)}else{if(j.enable||j.disable===false){if(j.resizable||j.movable)$box.mousemove(areaMouseMove).mousedown(areaMouseDown);$(window).resize(windowResize)}if(!j.persistent)l.add($outer).mousedown(imgMouseDown)}j.enable=j.disable=undefined}this.remove=function(){setOptions({disable:true});$box.add($outer).remove()};this.getOptions=function(){return j};this.setOptions=setOptions;this.getSelection=getSelection;this.setSelection=setSelection;this.cancelSelection=cancelSelection;this.update=doUpdate;var n=(/msie ([\w.]+)/i.exec(ua)||[])[1],opera=/opera/i.test(ua),safari=/webkit/i.test(ua)&&!/chrome/i.test(ua);$p=l;while($p.length){zIndex=max(zIndex,!isNaN($p.css('z-index'))?$p.css('z-index'):zIndex);if($p.css('position')=='fixed')position='fixed';$p=$p.parent(':not(body)')}zIndex=j.zIndex||zIndex;if(n)l.attr('unselectable','on');$.imgAreaSelect.keyPress=n||safari?'keydown':'keypress';if(opera)$areaOpera=div().css({width:'100%',height:'100%',position:'absolute',zIndex:zIndex+2||2});$box.add($outer).css({visibility:'hidden',position:position,overflow:'hidden',zIndex:zIndex||'0'});$box.css({zIndex:zIndex+2||2});$area.add($border).css({position:'absolute',fontSize:0});g.complete||g.readyState=='complete'||!l.is('img')?imgLoad():l.one('load',imgLoad);if(!imgLoaded&&n&&n>=7)g.src=g.src};$.fn.imgAreaSelect=function(a){a=a||{};this.each(function(){if($(this).data('imgAreaSelect')){if(a.remove){$(this).data('imgAreaSelect').remove();$(this).removeData('imgAreaSelect')}else $(this).data('imgAreaSelect').setOptions(a)}else if(!a.remove){if(a.enable===undefined&&a.disable===undefined)a.enable=true;$(this).data('imgAreaSelect',new $.imgAreaSelect(this,a))}});if(a.instance)return $(this).data('imgAreaSelect');return this}})(jQuery);
